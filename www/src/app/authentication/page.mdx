export const metadata = {
  title: 'Authentication - SonicJS',
  description:
    'Secure your SonicJS application with Better Auth: session-based authentication, RBAC, and optional magic link, OTP, and OAuth.',
}

export const sections = [
  { title: 'Overview', id: 'overview' },
  { title: 'Session Authentication', id: 'session-authentication' },
  { title: 'Magic Link & Email OTP', id: 'magic-link-otp' },
  { title: 'User Management', id: 'user-management' },
  { title: 'RBAC', id: 'rbac' },
]

# Authentication

Secure your SonicJS application with Better Auth: session-based authentication and role-based access control. {{ className: 'lead' }}

## Overview

SonicJS uses **Better Auth** for sign-in, sign-up, and sessions:

- **Session cookie** â€” HTTP-only `better-auth.session_token` (no JWT in app code)
- **Email/password** â€” `POST /auth/sign-in/email`, `POST /auth/sign-up/email`
- **RBAC** â€” First user gets `admin`, others get `viewer` by default
- **Extensible** â€” Add Google, magic link, email OTP, 2FA via `auth.extendBetterAuth`

<FeatureGrid
  features={[
    {
      icon: 'ðŸ”',
      title: 'Session-Based Auth',
      description: 'Better Auth sessions with HTTP-only cookies and optional DB storage',
    },
    {
      icon: 'ðŸ‘¥',
      title: 'User Roles',
      description: 'Admin, Editor, and Viewer roles with different permissions',
    },
    {
      icon: 'ðŸ”—',
      title: 'Magic Link & OTP',
      description: 'Add passwordless login via Better Auth plugins in config',
    },
    {
      icon: 'ðŸ”’',
      title: 'Secure by Default',
      description: 'HTTP-only cookies, CSRF protection, and configurable rate limiting',
    },
  ]}
  columns={2}
/>

---

## Session Authentication

### Login

<ApiEndpoint method="POST" path="/auth/sign-in/email" description="Sign in with email and password (Better Auth)" auth={false} />

<CodeGroup title="Sign-in Request">

```bash {{title:'cURL'}}
curl -X POST http://localhost:8787/auth/sign-in/email \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@sonicjs.com",
    "password": "sonicjs!"
  }' \
  -c cookies.txt
```

```javascript
const response = await fetch('http://localhost:8787/auth/sign-in/email', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'admin@sonicjs.com',
    password: 'sonicjs!'
  }),
  credentials: 'include'
});
```

</CodeGroup>

On success, Better Auth sets a session cookie. Use `credentials: 'include'` in browsers so the cookie is sent on later requests.

### Using the Session

Include the session cookie on authenticated requests. In browsers, send credentials:

<CodeGroup title="Authenticated Request">

```bash {{title:'cURL'}}
curl http://localhost:8787/auth/me \
  -b cookies.txt
```

```javascript
const response = await fetch('http://localhost:8787/auth/me', {
  credentials: 'include'
});
```

</CodeGroup>

### Registration

<ApiEndpoint method="POST" path="/auth/sign-up/email" description="Create account (Better Auth)" auth={false} />

Send `email`, `password`, and `name`. Optional fields (e.g. `username`, `firstName`, `lastName`) depend on your Better Auth user config. First registered user gets the `admin` role.

---

## Magic Link & Email OTP

Passwordless login (magic link or email OTP) is added via **Better Auth plugins** in your app config, not as separate SonicJS plugins.

### Magic Link

1. Add the `magicLink` plugin in `auth.extendBetterAuth` and implement `sendMagicLink` (e.g. with your email service).
2. Use the Better Auth client with `magicLinkClient` and call `signIn.magicLink({ email, callbackURL })`.

See [Better Auth â€“ Magic Link](https://www.better-auth.com/docs/plugins/magic-link) and [docs/authentication.md](https://github.com/sonicjs/sonicjs/blob/main/docs/authentication.md#magic-link-better-auth-plugin) for a full SonicJS example.

### Email OTP

1. Add the `emailOtp` plugin in `auth.extendBetterAuth` and implement `sendVerificationOTP({ email, otp, type })`.
2. Use the Better Auth client with `emailOtpClient` and call `authClient.emailOtp.sendVerificationOtp({ email, type: 'sign-in' })`, then verify the OTP.

See [Better Auth â€“ Email OTP](https://www.better-auth.com/docs/plugins/email-otp) and [docs/authentication.md](https://github.com/sonicjs/sonicjs/blob/main/docs/authentication.md#email-otp-better-auth-plugin) for a full SonicJS example.

<Callout type="info">
**Config, not plugins:** Magic link and email OTP are enabled by extending Better Auth in `SonicJSConfig.auth.extendBetterAuth`, not by activating plugins in the admin panel.
</Callout>

---

## User Management

### Pages

- **GET** `/auth/login` â€” Login form (submits to `POST /auth/sign-in/email`)
- **GET** `/auth/register` â€” Registration form (submits to `POST /auth/sign-up/email`)
- **GET** `/auth/me` â€” Current user (requires session cookie)
- **GET** or **POST** `/auth/logout` â€” Sign out (calls Better Auth sign-out, redirects to login)

Required env: `BETTER_AUTH_SECRET` (min 32 chars), `BETTER_AUTH_URL`. See [deployment](/deployment).

---

## RBAC

### User Roles

SonicJS supports built-in roles:

<Properties>
  <Property name="admin" type="string">
    Full system access. Can manage users, content, settings, and plugins.
  </Property>
  <Property name="editor" type="string">
    Content management. Can create, edit, publish, and delete content.
  </Property>
  <Property name="viewer" type="string">
    Read-only access. Can view content but not modify.
  </Property>
</Properties>

### Middleware

Protect routes with authentication and role-based middleware:

<CodeGroup title="Middleware Protection">

```typescript
// Require authentication
app.use('/admin/*', requireAuth())

// Require specific role
app.use('/admin/*', requireRole(['admin', 'editor']))

// Require permission
app.use('/admin/settings/*', requirePermission('manage:settings'))

// Optional authentication
app.use('/api/*', optionalAuth())
```

</CodeGroup>

---

## Next Steps

<div className="not-prose">
  <Button href="/api" variant="text" arrow="right">
    <>Explore the full API reference</>
  </Button>
</div>

<div className="not-prose mt-4">
  <Button href="/deployment" variant="text" arrow="right">
    <>Deploy to production</>
  </Button>
</div>
